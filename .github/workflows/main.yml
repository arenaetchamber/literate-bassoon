name: macOS SSH Terminal + localtonet (Random SSH Key - No Secret)

on: workflow_dispatch

jobs:
  macos-ssh-terminal:
    runs-on: macos-latest
    timeout-minutes: 9999

    steps:
      - name: Enable SSH Terminal + Generate SSH Key
        run: |
          # SSH ржЪрж╛рж▓рзБ ржХрж░рж╛ (ржпржжрж┐ ржирж╛ ржерж╛ржХрзЗ)
          sudo systemsetup -setremotelogin on
          
          # SSH key ржЬрзЗржирж╛рж░рзЗржЯ ржХрж░рж╛ (ржкрж╛рж╕ржлрзНрж░рзЗржЬ ржЫрж╛ржбрж╝рж╛)
          ssh-keygen -t ed25519 -N "" -f ~/.ssh/id_ed25519 -q
          
          # Public key authorized_keys-ржП ржпрзЛржЧ ржХрж░рж╛
          cat ~/.ssh/id_ed25519.pub >> ~/.ssh/authorized_keys
          chmod 600 ~/.ssh/authorized_keys
          
          # ржкрзНрж░рж╛ржЗржнрзЗржЯ key ржкрзНрж░рж┐ржирзНржЯ ржХрж░рж╛ (ржХржкрж┐ ржХрж░рзЗ рж░рж╛ржЦрзЛ!)
          echo "ЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФС"
          echo "ЁЯФС YOUR PRIVATE SSH KEY (ржХржкрж┐ ржХрж░рзЗ рж▓рзЛржХрж╛рж▓ ржлрж╛ржЗрж▓рзЗ рж╕рзЗржн ржХрж░рзЛ, ржпрзЗржоржи: id_ed25519):"
          cat ~/.ssh/id_ed25519
          echo "ЁЯФС (ржПржЯрж╛ ржПржХржмрж╛рж░ ржжрзЗржЦрж╛ ржпрж╛ржмрзЗ тАФ рж╕рж┐ржХрж┐ржЙрж░рж▓рж┐ рж╕рзЗржн ржХрж░рзЛ!)"
          echo "ЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФСЁЯФС"
          
          echo "тЬЕ SSH Server ржЪрж╛рж▓рзБ рж╣рзЯрзЗржЫрзЗ (Port 22) with Key Auth"

      - name: Start SSH Tunnel (Auto-Reconnect) - Terminal Access
        run: |
          echo "---------------------------------------------------"
          echo "ЁЯФЧ Localtonet SSH Tunnel ржЪрж╛рж▓рзБ рж╣рзЯрзЗржЫрзЗ"
          echo "SSH Host : enpezu0zf.localto.net"
          echo "SSH Port : 2222"
          echo "Username : runner"
          echo "---------------------------------------------------"
          echo "Connect ржХрж░рж╛рж░ ржХржорж╛ржирзНржб (рж▓рзЛржХрж╛рж▓ ржЯрж╛рж░рзНржорж┐ржирж╛рж▓ ржерзЗржХрзЗ):"
          echo "1. ржкрзНрж░рж╛ржЗржнрзЗржЯ key ржлрж╛ржЗрж▓рзЗ рж╕рзЗржн ржХрж░рзЛ (chmod 600 id_ed25519)"
          echo "2. ssh -i id_ed25519 runner@enpezu0zf.localto.net -p 2222"
          echo "---------------------------------------------------"

          maxRetries=1000
          retryCount=0

          while [ $retryCount -lt $maxRetries ]; do
            echo "Establishing SSH Tunnel... (Attempt: $retryCount)"
            
            ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o StrictHostKeyChecking=no \
                -o ExitOnForwardFailure=yes \
                -T -o RequestTTY=no \
                -p 223 IDRb6Izsh3blrA9ZBjmV-OI2mis9-4pwC1d8-PHcfoU3BZZ3a8yw5qBTHpmMwj00r0CY8xeknjEHqeZgYCp8Tw@enpezu0zf.localto.net \
                -R2222:127.0.0.1:22 -N || true
            
            echo "Tunnel Disconnected! Reconnecting in 5 seconds..."
            sleep 5
            retryCount=$((retryCount+1))
          done
