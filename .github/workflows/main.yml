name: macOS SSH Terminal Only + localtonet (Key Auth - No Password)

on: workflow_dispatch

jobs:
  macos-ssh-terminal:
    runs-on: macos-latest
    timeout-minutes: 9999

    steps:
      - name: Enable SSH + Generate & Authorize Key
        run: |
          # SSH ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶æ
          sudo systemsetup -setremotelogin on
          
          # SSH key ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü (‡¶Ø‡¶¶‡¶ø ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá)
          ssh-keygen -t ed25519 -N "" -f ~/.ssh/id_ed25519 -q || true
          
          # Public key authorized_keys-‡¶è ‡¶Ø‡ßã‡¶ó (‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá ‡¶®‡¶æ)
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          cat ~/.ssh/id_ed25519.pub >> ~/.ssh/authorized_keys
          chmod 600 ~/.ssh/authorized_keys
          
          # ‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶≠‡ßá‡¶ü key ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü (‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßá ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßã!)
          echo "üîëüîëüîëüîëüîëüîëüîëüîëüîëüîëüîëüîëüîëüîëüîëüîë"
          echo "üîë YOUR PRIVATE SSH KEY (‡¶è‡¶ü‡¶æ ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßá ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßã: id_ed25519)"
          cat ~/.ssh/id_ed25519
          echo "üîë (‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‚Äî ‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶∞ ‡¶ú‡¶æ‡¶Ø‡¶º‡¶ó‡¶æ‡¶Ø‡¶º ‡¶∞‡¶æ‡¶ñ‡ßã!)"
          echo "üîëüîëüîëüîëüîëüîëüîëüîëüîëüîëüîëüîëüîëüîëüîëüîë"

      - name: Start SSH Tunnel with Auto-Reconnect
        run: |
          echo "---------------------------------------------------"
          echo "SSH Host : tgpxodnb8.localto.net"
          echo "SSH Port : 5920"
          echo "Username : runner"
          echo "---------------------------------------------------"
          echo "‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° (‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶ü‡¶æ‡¶∞‡ßç‡¶Æ‡¶ø‡¶®‡¶æ‡¶≤ ‡¶•‡ßá‡¶ï‡ßá):"
          echo "1. ‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶≠‡ßá‡¶ü key ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßã ‚Üí echo '‡¶™‡ßá‡¶∏‡ßç‡¶ü key' > id_ed25519"
          echo "2. chmod 600 id_ed25519"
          echo "3. ssh -i id_ed25519 runner@tgpxodnb8.localto.net -p 5920"
          echo "---------------------------------------------------"

          # Auto-reconnect loop
          maxRetries=1000
          retryCount=0

          while [ $retryCount -lt $maxRetries ]; do
            echo "Tunnel ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá... (Attempt: $retryCount)"
            
            ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=3 \
                -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                -T -o RequestTTY=no \
                -p 223 01Q9lL7t6NscCsX69hVFR8Qzhnkx1854uIO87NU3VRkVSobpSMrs036-mqP6JJy08MA3SK1xImF71qw-Y47M5g@tgpxodnb8.localto.net \
                -R5920:127.0.0.1:22 -N || true
            
            echo "Tunnel ‡¶¨‡¶®‡ßç‡¶ß! ‡ß´ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ..."
            sleep 5
            retryCount=$((retryCount+1))
          done
