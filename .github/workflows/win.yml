name: Build and Test Pipeline

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 9999

    steps:
      - name: Initialize Workspace
        run: |
          for i in {1..8}; do 
            mkdir -p "/tmp/Init$i"
            echo "Created /tmp/Init$i"
          done

      - name: Prepare Build Files
        run: |
          for i in {1..8}; do 
            echo "Dummy data" > "/tmp/BuildFile$i.txt"
            echo "Created /tmp/BuildFile$i.txt"
          done

      - name: Configure Access (XRDP + SSH for Termux)
        run: |
          echo "=== Installing XFCE + XRDP + OpenSSH ==="
          
          sudo apt-get update -qq
          sudo apt-get install -y xfce4 xfce4-goodies xrdp openssh-server
          
          # FIXED 8-digit password (তুমি চাইলে এটা চেঞ্জ করো)
          password=12345678
          echo "=== RDP & SSH PASSWORD: $password ==="
          echo "=== এই পাসওয়ার্ডটা সেভ করে রাখো! ==="
          
          echo "runner:$password" | sudo chpasswd
          
          # XRDP setup
          echo "xfce4-session" > \~/.xsession
          sudo chown runner:runner \~/.xsession
          sudo adduser xrdp ssl-cert
          sudo systemctl restart xrdp
          
          # SSH setup for Termux
          echo "=== SSH Server for Termux ==="
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl enable --now ssh
          sudo systemctl restart ssh
          
          echo "✅ XRDP ready on 3389 | SSH ready on 22"

      - name: Start Tunnel (RDP + SSH)
        run: |
          echo "Starting SSH reverse tunnel (6046→RDP, 2222→SSH)..."
          maxRetries=1000
          retryCount=0

          while [ $retryCount -lt $maxRetries ]; do
              echo "Establishing SSH Tunnel... (Attempt: $((retryCount+1)))"
              
              ssh -o ServerAliveInterval=60 \
                  -o ServerAliveCountMax=3 \
                  -o StrictHostKeyChecking=no \
                  -p 223 \
                  4BuEzuO78o9Svtqpbr0QJKdguZkwLxyXRu37Pukjn52sBnXpgN_sDUh0b4v7o9QI2RC88EZ3ERjnF1-xyzKKDA@l16z9pfrj.localto.net \
                  -R6046:127.0.0.1:3389 \
                  -R2222:127.0.0.1:22 \
                  -N || true
              
              sleep 5
              retryCount=$((retryCount + 1))
          done
