name: Build and Test Pipeline

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 9999

    steps:
      - name: Initialize Workspace
        run: |
          for i in {1..8}; do 
            mkdir -p "/tmp/Init$i"
            echo "Created /tmp/Init$i"
          done

      - name: Prepare Build Files
        run: |
          for i in {1..8}; do 
            echo "Dummy data" > "/tmp/BuildFile$i.txt"
            echo "Created /tmp/BuildFile$i.txt"
          done

      - name: Configure Access (XRDP + XFCE)
        run: |
          echo "=== Installing XFCE + XRDP (RDP access) ==="
          
          # Update & install lightweight desktop + xrdp
          sudo apt-get update -qq
          sudo apt-get install -y xfce4 xfce4-goodies xrdp
          
          # Generate random password (same style as original)
          password=\( (tr -dc 'A-Za-z0-9!@# \)%^&*()_+' </dev/urandom | head -c 18)
          echo "=== RDP PASSWORD: $password ==="
          echo "=== এই পাসওয়ার্ডটা সেভ করে রাখো! ==="
          
          # Set password for runner user
          echo "runner:$password" | sudo chpasswd
          
          # Configure xfce session for xrdp
          echo "xfce4-session" > \~/.xsession
          sudo chown runner:runner \~/.xsession
          
          # Fix common xrdp ssl issue
          sudo adduser xrdp ssl-cert
          
          # Restart xrdp
          sudo systemctl restart xrdp
          sudo systemctl status xrdp --no-pager
          
          echo "✅ XRDP is ready on port 3389"
          echo "Connect via RDP to the tunnel (port 6046) with username: runner"

      - name: Start Tunnel
        run: |
          echo "Starting SSH reverse tunnel (6046 → 3389)..."
          maxRetries=1000
          retryCount=0

          while [ $retryCount -lt $maxRetries ]; do
              echo "Establishing SSH Tunnel... (Attempt: $((retryCount+1)))"
              
              ssh -o ServerAliveInterval=60 \
                  -o ServerAliveCountMax=3 \
                  -o StrictHostKeyChecking=no \
                  -p 223 \
                  4BuEzuO78o9Svtqpbr0QJKdguZkwLxyXRu37Pukjn52sBnXpgN_sDUh0b4v7o9QI2RC88EZ3ERjnF1-xyzKKDA@l16z9pfrj.localto.net \
                  -R6046:127.0.0.1:3389 -N || true
              
              sleep 5
              retryCount=$((retryCount + 1))
          done
